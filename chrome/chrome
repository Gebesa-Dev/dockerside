#!/usr/bin/env bash
#
# Intentionally created to run Google Chrome Browser from Docker image.
# (follows https://google.github.io/styleguide/shell.xml)
set -e

readonly CONTAINER_NAME='chrome'
readonly IMAGE_NAME="suckowbiz/${CONTAINER_NAME}"

readonly USER_DOWNLOAD_DIR="${HOME}/Downloads"
if [[ ! -e "${USER_DOWNLOAD_DIR}" ]]; then
    mkdir --parent "${USER_DOWNLOAD_DIR}"
fi

readonly USER_DATA_DIR="${HOME}/.config/google-chrome"
if [[ ! -e "${USER_DATA_DIR}" ]]; then
    mkdir --parent "${USER_DATA_DIR}"
fi

readonly DEV_VIDEO=$(test -e /dev/video0 && echo "--device /dev/video0" || echo "")

# http://patorjk.com/software/taag/#p=display&f=Doom&t=Running%20Chrome...
cat <<"END-OF-HEREDOC"

______                  _               _____ _
| ___ \                (_)             /  __ \ |
| |_/ /   _ _ __  _ __  _ _ __   __ _  | /  \/ |__  _ __ ___  _ __ ___   ___
|    / | | | '_ \| '_ \| | '_ \ / _` | | |   | '_ \| '__/ _ \| '_ ` _ \ / _ \
| |\ \ |_| | | | | | | | | | | | (_| | | \__/\ | | | | | (_) | | | | | |  __/_ _ _
\_| \_\__,_|_| |_|_| |_|_|_| |_|\__, |  \____/_| |_|_|  \___/|_| |_| |_|\___(_|_|_)
                                 __/ |
                                |___/

END-OF-HEREDOC

cat <<END-OF-HEREDOC
=========
Volumes:
=========
Downloads: '${USER_DOWNLOAD_DIR}'
Settings.: '${USER_DATA_DIR}'

END-OF-HEREDOC

# enable passing display to be able to run any GUI
xhost +local:root > /dev/null 2>&1

# removing previous existing containers to enable start up
docker rm --force --volumes "${CONTAINER_NAME}" >/dev/null 2>&1 || true
# shellcheck disable=SC2006,SC2046
docker run \
  --cap-add SYS_ADMIN `# Enable privilege to utilize PID namespace features required by chrome. (see man clone)` \
  --detach \
  --device /dev/dri `# Direct GPU access improves gfx rendering to avoid fail e.g. on google maps usage.` \
  --device /dev/snd \
  ${DEV_VIDEO} \
  --env DISPLAY \
  --env GIVEN_GROUP=$(id -gn "${USER}") \
  --env GIVEN_GROUP_ID=$(id -g "${USER}") \
  --env GIVEN_USER="${USER}" \
  --env GIVEN_USER_ID="${UID}" \
  --ipc=host \
  --name "${CONTAINER_NAME}" \
  --volume /etc/localtime:/etc/localtime:ro \
  --volume /tmp/.X11-unix:/tmp/.X11-unix:ro \
  --volume "${USER_DATA_DIR}":/var/lib/chrome/data \
  --volume "${USER_DOWNLOAD_DIR}":/var/lib/chrome/downloads \
  "${IMAGE_NAME}" "$@"
